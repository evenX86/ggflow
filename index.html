<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="stylesheet" href="style.css" type="text/css" />
<script type="text/javascript" src="gflow.js"></script>
<script src="d3.v3.js"></script>
<script src="sankey.js"></script>
<title>访问流</title>
</head>

<body>
<div id="ID-view" class="uK wA">
  <div class = "p0">
    <div class = "qz">
      <div id = "ID-reportContainer" class = "Zj">
        <div id = "ID-report" class = "ds">
          <div class = "Mj">
            <div id = "ID-flowReportHeader">标题|时间选择|维度选择</div>
            <div class="Wj tzb">
              <div id = "ID-tab">
                <div>
                  <div id = "ID-intelligenceFlow-visitsFlow">
                    <div class = "ID-segmentInfo cwb"></div>
                    <div class="ID-fixedContainer vub">
                      <div class="J4">
                        <div id = "ID-scrollContainer" class="ID-scrollContainer n7">
                          <div id="ID-flowHeader">
                            <div class="Dvb">
                              <table class="ID-flowHeaderElement qo" style="margin-left:100px">
                              	<tbody>
                               	 	<tr>
                                    	<th width="280">
                                        	<div class = "ID-dimension ACTION-showDimensionPicker TARGET- yd tg Br">国家/地区</div>
                                            <div class="ID-dimension-details ACTION-showDimensionDetails TARGET- uB">
                                            	<div class="XO"></div> 
                                            </div>
                                        </th>
                                        <th width="280">
                                        	<div class = "nB">起始网页</div>
                                            <div class = "ttb">在 35.4K 次访问中，有 19.1K 次访问者中途离开</div>
                                        </th>
                                    </tr>
                              	</table>
                              </tbody>
                            </div>
                          </div>
                          <div class="ID-svcGraph D0">
                              <p id="chart">
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
</body>
<script>

    var margin = {top: 1, right: 1, bottom: 6, left: 1},
            width = 4300 - margin.left - margin.right,
            height = 500 - margin.top - margin.bottom;

    var formatNumber = d3.format(",.0f"),
            format = function(d) { return formatNumber(d) + " 访问次数"; },
            format_for_node = function(d) { return formatNumber(d) + " 浏览流量"; },
            color = d3.scale.category20();  /*颜色是随机变化的*/

    var svg = d3.select("#chart").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    var sankey = d3.sankey()
            .nodeWidth(187)
            .nodePadding(10)        //nodePadding 是指同一列中node之间的距离
            .size([width, height]);

    var path = sankey.link();



    d3.json("data.json", function(energy) {

        sankey
                .nodes(energy.nodes)
                .links(energy.links)
                .layout(0);

        var link = svg.append("g").selectAll(".link")
                .data(energy.links)
                .enter().append("path")
                .attr("class", "link")
                .attr("d", path)
                .style("stroke-width", function(d) { return Math.max(1, d.dy); })
                .sort(function(a, b) { return b.dy - a.dy; });

        /*显示路径的说明*/
        link.append("title")
                .text(function(d) { return d.source.name + " 到 " + d.target.name + "\n" + format(d.value); });

        var node = svg.append("g").selectAll(".node")
                .data(energy.nodes)
                .enter().append("g")
                .attr("class", "node")
                .attr("transform", function(d) {return "translate(" + d.x + "," + d.y + ")"; })
                .call(d3.behavior.drag()
                        .origin(function(d) { return d; })
                        .on("dragstart", function() { this.parentNode.appendChild(this); })
                        .on("drag", dragmove));   /*拖动*/

        node.append("rect")
                .attr("height", function(d) { return d.dy; })
                .attr("width", sankey.nodeWidth())
                .style("fill", function(d) { return d.color = color(d.name.replace(/ .*/, "")); })
                .style("stroke", function(d) { return d3.rgb(d.color).darker(2); })
                .append("title")
                .text(function(d) { return d.name + "\n" + format_for_node(d.value); });

        node.append("text")
                .attr("y", function(d) { return d.dy / 2; })
                .attr("dy", ".35em")
                .attr("text-anchor", "end")
                .attr("transform", null)
                .text(function(d) { return d.name; })
                .filter(function(d) { return d.x < width / 2; })
                .attr("x", 6 + sankey.nodeWidth())  //删掉了上面对x属性赋值的操作,没啥用~主要是为了改变附加的说明,这个到后面换成标签
                .attr("text-anchor", "start");

        function dragmove(d) {
            d3.select(this).attr("transform", "translate(" + d.x + "," + (d.y = Math.max(0, Math.min(height - d.dy, d3.event.y))) + ")");
            sankey.relayout();
            link.attr("d", path);
        }
    });

</script>
</html>
